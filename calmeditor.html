<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>calm editor</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="shortcut icon" href="https://dl.dropboxusercontent.com/u/217196740/calmfavicon.ico">
    <link rel="apple-touch-icon" href="https://dl.dropboxusercontent.com/u/217196740/calmicon.png" />

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

    <style type="text/css">
      html,body {
      height: 96%;
      margin: 4px;
      padding: 0;
      color: #444;
      font-family: 'Noto Sans CJK JP',sans-serif;
      background-color: #eee;
background-image: url("https://dl.dropboxusercontent.com/u/217196740/img/45-degree-fabric-light.png");
      }
      #editor {
      height: 100%;
      max-width:720px;
      margin:0 auto;
      padding:8px 8px 16px;
      border-radius:4px;
      background: #f5f5f5;
      }
      #btns {
      float:right;
      }
      textarea {
      height: 94%;
      width: 100%;
      max-width: 100%;
      resize: none;
      border:none;
      font-size: 18px;
      letter-spacing: 0.1em;
      line-height: 1.6em;
      font-family: 'Noto Sans CJK JP',sans-serif;
      background: transparent;
      color: #333;
      }
      textarea:focus{outline: none;}
      #header {
      margin-bottom: 8px;
      padding-bottom:8px;
      border-bottom:1px dashed #bbb;
      }
    </style>
  </head>

  <body>
    <div id="editor">
      <div id="header">
        c:<span class="count">0</span>
        <div id="btns">
          <button class="btn" type="button" onclick="sendText()" >Textwell</button>
          <button id="clear" class="btn">clear</button>
          <button class="btn" type="button"onclick=window.open("https://www.noisli.com/get_combo_by_link/86fe8099Tm8nZqX")>noisli</button>
        </div>
        <br style="clear:both;">
      </div>
      <textarea id="edit" placeholder="keep calm and write on."></textarea>
    </div>
    <script type="text/javascript">
      $(function(){
          $('textarea').bind('keydown keyup keypress change',function(){
              var thisValueLength = $(this).val().length;
              $('.count').html(thisValueLength);
          });
      });
    </script>

    <script type="text/javascript">
      // 読み込み
      var textarea = $("#edit");
      textarea.ready(function(){
        textarea.val(localStorage.getItem("edit"));
      });

      // Query
      var match = location.search.match(/text=(.*?)(&|$)/);
      if(match) {
          qtext = decodeURIComponent(match[1]);
          textarea.ready(function(){
            textarea.val(qtext);
            });
      }
      var match = location.search.match(/add=(.*?)(&|$)/);
      if(match) {
          qtext = decodeURIComponent(match[1]);
          textarea.ready(function(){
            textarea.val(localStorage.getItem("edit") + "\n" + qtext);
            });
      }
      textarea.ready(function(){
      var url = location.href
      var new_url = url.replace(/\?.*$/,"");
      window.history.pushState(null, null, new_url);
      });

      // 保存
      textarea.keyup(function(){
        var value = textarea.val();
        localStorage.setItem("edit", value);
      });
      // 削除
      $("#clear").click(function(){
        textarea.val("");
        localStorage.clear();
      });
    </script>

    <script>
      // カーソル
      var p, mode, nowEdit;
      document.ontouchmove = touchMove;
      document.ontouchstart = touchStart;

      function touchMove(e) {
          t = e.touches[0].pageX;
          if (t - p > 6) {
              var f = document.getElementById(nowEdit);
              f.setSelectionRange(f.selectionStart + mode, f.selectionEnd + 1);
              p = t;
          }
          if (p - t > 6) {
              var f = document.getElementById(nowEdit);
              f.setSelectionRange(f.selectionStart - mode, f.selectionEnd - 1);
              p = t;
          }
      }

      function touchStart(e) {
          nowEdit = document.activeElement.id;
          p = e.touches[0].pageX;
          mode = (nowEdit.selectionStart == nowEdit.selectionEnd);
      }

      window.scroll(0, 33);
    </script>

    <script>
      // 半透明
      $('#edit')
        .focusin(function(e) {
          $('#header').css("opacity", "0.2");
          $('#header').css("transition", "all 0.5s");
        })
        .focusout(function(e) {
          $('#header').css("opacity", "1");
        });
      // 送信
      function sendText() {
          location.href = 'textwell://insert?text=' + encodeURIComponent(edit.value);
      }
    </script>

  </body>
</html>
